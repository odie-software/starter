# Dockerfile
FROM node:22 AS base

# Install pnpm globally
RUN npm install -g pnpm

# Set working directory
ENV NODE_ENV=development
WORKDIR /app

# Build stage
FROM base AS build

# Copy dependency files
COPY --link package.json pnpm-lock.yaml ./

# Set ownership to node user
RUN chown -R node:node .

# Switch to node user
USER node

# Configure and run pnpm install
RUN pnpm config set store-dir /app/.pnpm-store
RUN pnpm install

# Final run stage
FROM base

# Copy installed node_modules from build stage
COPY --from=build --chown=node:node /app/node_modules /app/node_modules

# Switch to node user
USER node

# Start the application
CMD [ "npm", "run", "dev" ]